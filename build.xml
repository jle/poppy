<?xml version="1.0" encoding="UTF-8"?>
<project name="poppy" basedir="." default="jar">

    <property name="bin.dir" value="bin"/>
    <property name="src.dir" value="src"/>
    <property name="classes.dir" value="${bin.dir}/classes"/>
    <property name="ant.test.lib" value="ant-testutil.jar"/>
    <property name="report.dir"   value="report"/>
    <property name="junit.out.dir.xml"  value="${report.dir}/junit/xml"/>
    <property name="junit.out.dir.html" value="${report.dir}/junit/html"/>
    <property name="out.jar" value="${bin.dir}/${ant.project.name}.jar"/>

    <property name="poppy.dest.dir" value="gen"/>
    <property name="poppy.classname" value="com.poppy.P"/>
    <property name="poppy.include.dir" value="config"/>
    <property name="sample" value="false"/>

    <path id="classpath.compile">
        <fileset dir="lib">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <path id="classpath.run">
        <path path="${java.class.path}"/>
        <path location="${out.jar}"/>
        <path refid="classpath.compile"/>
    </path>

    <path id="classpath.test">
        <path refid="classpath.run"/>
        <path location="${ant.test.lib}"/>
    </path>

    <target name="clean" description="Delete all generated files">
        <delete failonerror="false" includeEmptyDirs="true">
            <fileset dir="${classes.dir}"/>
            <fileset dir="${report.dir}"/>
            <fileset dir="${bin.dir}"/>
            <fileset dir="${poppy.dest.dir}"/>
        </delete>
    </target>

    <target name="compile" description="Compiles the Task">
        <mkdir dir="${classes.dir}"/>
        <javac srcdir="src" destdir="${classes.dir}" includeantruntime="true">
            <classpath refid="classpath.compile"/>
        </javac>
    </target>

    <target name="jar" description="JARs the Task" depends="compile">
        <jar destfile="${out.jar}" basedir="${classes.dir}"/>
    </target>

    <target name="use" description="Use the Task" depends="jar">
        <taskdef name="poppy" classname="com.poppy.Poppy" classpath="${out.jar}"/>
        <poppy classname="${poppy.classname}" destdir="${poppy.dest.dir}">
            <path>
                <fileset dir="${poppy.include.dir}" includes="**/*.properties"/>
            </path>
            <propertyset>
                <propertyref name="sample"/>
                <propertyref prefix="poppy"/>
            </propertyset>
        </poppy>
    </target>

    <target name="junit" description="Runs the unit tests" depends="jar">
        <delete dir="${junit.out.dir.xml}"/>
        <mkdir  dir="${junit.out.dir.xml}"/>
        <junit printsummary="yes" haltonfailure="no">
            <classpath refid="classpath.test"/>
            <formatter type="xml"/>
            <batchtest fork="yes" todir="${junit.out.dir.xml}">
                <fileset dir="${src.dir}" includes="**/*Test.java"/>
                <fileset dir="${src.dir}" includes="**/*Tests.java"/>
            </batchtest>
        </junit>
    </target>

    <target name="junitreport" description="Create a report for the rest result">
        <mkdir dir="${junit.out.dir.html}"/>
        <junitreport todir="${junit.out.dir.html}">
            <fileset dir="${junit.out.dir.xml}">
                <include name="*.xml"/>
            </fileset>
            <report format="frames" todir="${junit.out.dir.html}"/>
        </junitreport>
    </target>

    <target name="test"
            depends="junit, junitreport"
            description="Runs unit tests and creates a report" />
</project>